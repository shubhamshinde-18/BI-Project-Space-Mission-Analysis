"use strict";
this.parseTimeMarkers = this.parseTimeMarkers || {};
var marker = this.parseTimeMarkers['textboxVisual.min.js'] || (this.parseTimeMarkers['textboxVisual.min.js'] = {});
marker.startEval = window.jsCommon && window.jsCommon.performance && window.jsCommon.performance.now ? window.jsCommon.performance.now() : Date.now(); marker.isExternal = false;
if (window.perfTracking && window.perfTracking.startBundleEval) window.perfTracking.startBundleEval('textboxVisual.min.js');var es6,powerbi,__extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(t,e){for(var i=0,o=e.length,n=t.length;i<o;i++,n++)t[n]=e[i];return t};!function(l){var u,t,p;function s(t,e){return l.isValueRef(t)?i(t.selector.id,e):t}function i(t,e){t=null==e?void 0:e[t];return null==t?void 0:t.formattedValue}function c(t){return _.isDate(t)?7:_.isInteger(t)?4:_.isNumber(t)?3:_.isBoolean(t)?5:_.isString(t)?1:0}u=l.visuals||(l.visuals={}),t=u.TextEvaluation||(u.TextEvaluation={}),p=l.visuals.valueFormatter.VariantValueFormatter,t.combineEvaluatedTextRuns=function(t,e){for(var i=[],o=0,n=t;o<n.length;o++){var r=s(n[o].value,e);r&&i.push(r)}return i.join("")},t.evaluateTextRunConditional=function(t,e){var i;return i=l.isValueRef(t.expression)?(i=t.expression.selector.id,null==(i=null==e?void 0:e[i])?void 0:i.value):t.expression,u.ConditionalEvaluator.processCases(t,i).textRuns},t.getTextRunValue=s,t.getTextRunValueFormatted=i,t.isTextRun=function(t){return _.isString(t.value)||l.isValueRef(t.value)},t.isAtMentionTextRun=function(t){return!_.isNil(t.mentionEmail)},t.isTextRunConditional=function(t){return _.isArray(t.cases)&&!!t.defaultCase&&_.isArray(t.defaultCase.textRuns)&&(l.isValueRef(t.expression)||_.isString(t.expression)||_.isNumber(t.expression)||_.isBoolean(t.expression)||_.isDate(t.expression))},t.populateEvaluatedValues=function(t,e,i){var o=u.textboxProps.values.expr.objectName;u.textboxProps.values.formatString.objectName;var n=l.DataViewObjects.getUserDefinedObjects(t,o);if(!_.isEmpty(n)){for(var r in n){var s=l.DataViewObject.getValue(n[r],u.textboxProps.values.expr.propertyName),a=new p({column:{displayName:"",objects:n,type:l.ValueType.fromPrimitiveTypeAndCategory(c(s))},formatStringPropId:{objectName:r,propertyName:u.textboxProps.values.formatString.propertyName},nullsAreBlank:!1});e[r]={value:s,formattedValue:a.format(s)}}i&&i.trace(2,"TextboxWithSmartNarrativeValuesDataChanged")}},t.primitiveTypeFromPrimitiveValue=c}(powerbi=powerbi||{}),function(c){!function(F){var o=jsCommon.Color,d=jsCommon.CssConstants.createClassAndSelector,f=jsCommon.DOMConstants,y=jsCommon.FocusManager,n=jsCommon.FocusManagerFocusEventName,r=jsCommon.FocusNavModeAttribute,m=F.Units.FontSize,E=c.isValueRef,S=jsCommon.KeyUtils,N=jsCommon.StringExtensions,e=jsCommon.UrlUtils.UrlScheme,i=jsCommon.UrlUtils;F.mentionDefaultMaxSearchLength=48;var w,t,s,a=d("textboxFocusElement"),C={linkTooltip:d("ql-link-tooltip"),toolbarUrlInput:d("toolbar-url-input")};(t=w=F.TextboxFormatting||(F.TextboxFormatting={})).Fonts=["Arial","Arial Black","Arial Unicode MS","Calibri","Cambria","Cambria Math","Candara","Comic Sans MS","Consolas","Constantia","Corbel","Courier New","Georgia","Lucida Sans Unicode","Segoe (Bold)","Segoe UI","Segoe UI Light","Symbol","Tahoma","Times New Roman","Trebuchet MS","Verdana","Wingdings"],t.FontSizePrecision=1,t.FontSizes=[8,9,10,10.5,11,12,14,16,18,20,24,28,32,36,40,42,44,54,60,66,72,80,88,96],t.LegacyDefaultFont=F.Font.Family.light.family,t.LegacyFontSize=m.createFromPx(14),t.LegacyDefaultFontProperties={family:t.LegacyDefaultFont,size:t.LegacyFontSize},t.TextAlignments=["Left","Center","Right"],t.DefaultAlignment="Left",(s=t.TextScriptTypes||(t.TextScriptTypes={})).Super="Super",s.Sub="Sub",(t.TextListTypes||(t.TextListTypes={})).Bullet="bullet",t.getCSSFromFont=function(t){var e=F.Font.FamilyMap[t];return e?e.family:t},t.getFontFromCSS=function(e){return _.findKey(F.Font.FamilyMap,function(t){return t.family===e||0<t.family.indexOf(e)})||e};var x,l,v,A,u=(p.prototype.init=function(t){this.element=t.element,this.host=t.host,this.viewport=t.viewport,this.style=t.style,this.readOnly=0===this.host.getViewMode(),this.paragraphs=[],this.defaultFont=__assign({},w.LegacyDefaultFontProperties),this.fontFamilies=__spreadArray([],this.fontFamilies||w.Fonts||[]),this.fontSizes=__spreadArray([],this.fontSizes||w.FontSizes||[]),this.evaluatedValues={},this.quillEditorIsReady=this.host.promiseFactory().defer(),this.featureSwitches=t.featureSwitches,this.configureMentions(),this.refreshView()},p.prototype.onResizing=function(t){var e=this.viewport;this.viewport=t,this.updateSize(),this.viewModelAdapter&&this.viewModelAdapter.onResizing(this.element,this.viewport,e,this.defaultFont)},p.prototype.onDataChanged=function(t){var e=t.dataViews;this.evaluatedValues={},this.paragraphs=[],e&&0<e.length&&((t=e[0].metadata.objects)&&t.general&&(this.paragraphs=t.general.paragraphs),F.TextEvaluation.populateEvaluatedValues(t,this.evaluatedValues,this.host.telemetry()),e=F.ColorHelper.create(this.style),this.defaultFont=F.FontProperties.createFromObjectOrStyle(t&&t.text,{family:"fontFamily",size:"fontSize",color:"color"},e,this.style,"foreground","label",w.LegacyDefaultFontProperties)),this.mergeParagraphFontsWithStandardFonts(),this.refreshView()},p.prototype.getTelemetryInformation=function(){for(var t,e=!1,i=[],o=0,n=this.paragraphs;o<n.length;o++)for(var r=0,s=n[o].textRuns;r<s.length;r++){var a,l=s[r];F.TextEvaluation.isTextRunConditional(l)?(e=!0,_.isEmpty(l.cases)||(a=_.first(l.cases),i.push(_.round(a.pattern,-2)))):F.TextEvaluation.isTextRun(l)&&E(l.value)&&(e=!0)}return e&&((t={SmartNarratives:!0}).SummarizationTemplateIds=i.join(","),t=t),t},p.prototype.mergeParagraphFontsWithStandardFonts=function(){var t=__spreadArray(__spreadArray([],_.map(this.fontSizes,function(t){return m.createFromPt(t)})),[this.defaultFont.size]),e=_.chain(t).map(function(t){return t.pt}).uniqBy(function(t){return t}).sortBy(function(t){return t}).value(),i=w.getFontFromCSS(this.defaultFont.family),o=__spreadArray(__spreadArray([],this.fontFamilies),[i]),i=this.paragraphs;if(i)for(var n=0,r=i;n<r.length;n++){var s=r[n];if(s.textRuns)for(var a=0,l=s.textRuns;a<l.length;a++){var u,p=l[a],c=p&&F.TextEvaluation.isTextRun(p)&&p.textStyle;c&&(!c.fontSize||(u=m.createFromCSS(c.fontSize,w.FontSizePrecision))&&(this.restrictFontSizes?(p=_.sortedIndex(e,u.pt),c.fontSize=e[Math.min(p,e.length-1)]+"pt"):t.push(u)),c.fontFamily&&o.push(c.fontFamily))}}this.fontSizes=_.chain(t).map(function(t){return t.pt}).sortBy(function(t){return t}).uniqBy(function(t){return t}).value(),this.fontFamilies=_.chain(o).sortBy(function(t){return t}).uniqBy(function(t){return t}).value()},p.prototype.destroy=function(){this.editor&&(this.editor.destroy(),this.editor=void 0)},p.prototype.focus=function(){if(this.editor)return this.editor.focus(),!0},p.prototype.onViewModeChanged=function(t){this.readOnly=0===t,this.refreshView()},p.prototype.setSelection=function(t,e){this.editor,this.editor&&this.editor.setSelection(t,e)},p.prototype.getSelection=function(){return this.editor.getSelection()},p.prototype.ensureFocusableElement=function(){var t,e=this,i=this.element;i.find(a.selector).length||(t=$("<div>").width(0).height(0).attr("tabindex",0).addClass(a.class),i.append(t),t.on(n,function(){e.focus()}))},p.prototype.removeFocusableElement=function(){this.element.find(a.selector).remove()},p.prototype.refreshView=function(){var t,e,i=this;this.readOnly?(this.editor&&(this.saveContents(),this.editor.destroy(),this.editor=null),this.element.empty(),e=l.convertParagraphsToHtml(this.paragraphs,this.defaultFont,this.evaluatedValues,this.$mentionsHoverContainer,this.personCardComponent),t=$("<div>").addClass(p.ClassAndSelector.class).css(F.FontProperties.toHTMLStyle(this.defaultFont)).append(e),this.supportsAtMention&&t.append(this.$mentionsHoverContainer),this.viewModelAdapter&&this.viewModelAdapter.onDataChanged(t,this.viewport,this.defaultFont),e=void 0,this.disableScrollingInViewMode?this.element.append(e=t):(e=this.$scrollableDiv=$("<div></div>").addClass(p.ScrollWrapperClassAndSelector.class).css({height:this.viewport.height+"px","overflow-y":"auto","overflow-x":"hidden"}).append(t),this.element.append(this.$scrollableDiv)),this.removeFocusableElement(),e.attr("tabindex",0).attr("role","document").attr(r,"Browser").on("keydown",function(t){var e;27===t.keyCode&&null!==(e=i.$scrollableDiv)&&void 0!==e&&e.removeAttr(r).removeAttr("tabindex")}).focusout(function(){var t;null!==(t=i.$scrollableDiv)&&void 0!==t&&t.attr("tabindex",0).attr(r,"Browser")})):(t={defaultFont:this.defaultFont,evaluatedValues:this.evaluatedValues,fontFamilies:this.fontFamilies,fontSizes:this.fontSizes,supportsNarrativeExpressions:this.supportsNarrativeExpressions,textChangeThrottle:this.textChangeThrottle,onEscape:function(){return i.focus()},featureSwitches:this.featureSwitches,supportsFormattingChangeIndication:this.supportsFormattingChangeIndicationOptions},e=this.supportsFormattingChangeIndicationOptions&&!this.readOnly,this.editor?this.editor.updateOptions(t):(this.editor=new A.QuillWrapper(this.readOnly,this.host,this.style,t,this.supportsAtMention,this.$mentionsHoverContainer,this.personCardComponent,this.placeholderText,e),this.editor.textChanged=function(){return i.saveContents()},this.element.empty(),this.ensureFocusableElement(),(e=this.editor.getElement()).addClass(p.ClassAndSelector.class),this.element.append(e)),this.editor.getElement().css(F.FontProperties.toHTMLStyle(this.defaultFont)),this.editor.quillReady.promise.then(function(){i.quillEditorIsReady.resolve(),i.restrictFontSizes&&(i.editor.onPaste=function(){i.mergeParagraphFontsWithStandardFonts(),i.refreshView()});var t=i.editor.getSelection(),e=l.convertParagraphsToOps(i.paragraphs,i.evaluatedValues,i.editor,i.style,i.$mentionsHoverContainer,i.personCardComponent);i.editor.setContents(e),t&&i.editor.setSelection(t.index,t.length)})),this.updateSize()},p.prototype.saveContents=function(){var t;!this.editor||(t=this.editor.getContents())&&(this.paragraphs=l.convertDeltaToParagraphs(t,this.supportsNarrativeExpressions,this.evaluatedValues),t=[{objectName:"general",properties:{paragraphs:this.paragraphs},selector:null}],this.host.persistProperties(t))},p.prototype.updateSize=function(){this.editor?this.editor.resize(this.viewport):this.$scrollableDiv&&this.$scrollableDiv.css("height",this.viewport.height+"px")},p.prototype.configureMentions=function(){this.supportsAtMention&&(this.$mentionsHoverContainer=$("<span>").addClass(p.MentionsHoverClassAndSelector.class).hide(),this.personCardComponent=this.host.getUIComponentFactory().createPersonCard(this.$mentionsHoverContainer.get(0)))},p.prototype.onTextEditorReady=function(){return this.quillEditorIsReady.promise},p.ClassAndSelector=jsCommon.CssConstants.createClassAndSelector("textbox"),p.MentionsHoverClassAndSelector=d("mentions-hover"),p.ScrollWrapperClassAndSelector=jsCommon.CssConstants.createClassAndSelector("scrollWrapper"),p);function p(t){t&&(this.supportsNarrativeExpressions=!1!==t.supportsNarrativeExpressions,this.supportsAtMention=!!t.supportsAtMention,this.textChangeThrottle=t.textChangeThrottle,this.placeholderText=t.placeholderText,this.supportsFormattingChangeIndicationOptions=!!t.supportsFormattingChangeIndication,t.textChangeThrottle&&this.supportsNarrativeExpressions,this.fontFamilies=__spreadArray([],t.allowedFonts||w.Fonts||[]),this.fontSizes=__spreadArray([],t.allowedFontSizes||w.FontSizes||[]),this.restrictFontSizes=_.some(t.allowedFontSizes),t.viewModelAdapter&&(this.viewModelAdapter=t.viewModelAdapter),this.disableScrollingInViewMode=t.disableScrollingInViewMode,this.featureSwitches=t.featureSwitches)}function b(t,e){var i,o;return t&&(i=z(t)),e[A.QuillWrapper.atMentionBlotClass.class]&&!0!==e[A.QuillWrapper.atMentionBlotClass.class]&&(o={mentionEmail:(o=e[A.QuillWrapper.atMentionBlotClass.class]).email,value:null!==(e=o.displayName)&&void 0!==e?e:o.email},i&&(o.textStyle=i)),o}function T(t,e){var i,o,n;if(t&&((n=z(t))&&(i=n),void 0!==t.link&&P(t.link)&&(o=t.link)),e[A.QuillWrapper.smartNarrativesBlotClass.class]&&!0!==e[A.QuillWrapper.smartNarrativesBlotClass.class]){var r=(s=e[A.QuillWrapper.smartNarrativesBlotClass.class]).objRef;if(!r)return;if(r===A.QuillPlaceholder)return;r={textStyle:i,url:o,value:{propertyIdentifier:F.textboxProps.values.expr,selector:{id:r}}}}else if(e[A.QuillWrapper.smartNarrativesConditionalBlotClass.class]&&!0!==e[A.QuillWrapper.smartNarrativesConditionalBlotClass.class]){var s=e[A.QuillWrapper.smartNarrativesConditionalBlotClass.class];if(!F.TextEvaluation.isTextRunConditional(s.definition))return;for(var a=0,l=(r=s.definition).cases;a<l.length;a++)for(var u=0,p=l[a].textRuns;u<p.length;u++)(c=p[u]).textStyle=i,c.url=o;for(var c,h=0,d=r.defaultCase.textRuns;h<d.length;h++)(c=d[h]).textStyle=i,c.url=o}return r}function P(t){if(_.isEmpty(t))return!1;switch(i.getUrlScheme(t)){case e.http:case e.https:case e.mailto:return!0;default:return!1}}function z(t){var e,i={};return t.bold&&(i.fontWeight="bold"),t.font&&(e=F.Font.normalizeFamily(_.unescape(t.font),!1),e=w.getFontFromCSS(e),i.fontFamily=e),t.italic&&(i.fontStyle="italic"),t.size&&(i.fontSize=t.size),t.underline&&(i.textDecoration="underline"),t.color&&(i.color=t.color),t.script&&(i.lineHeight="0",i.position="relative",i.verticalAlign="baseline",i.scriptType=t.script,t.script===w.TextScriptTypes.Sub.toLowerCase()?i.bottom="-0.25em":i.top="-0.5em"),i}F.Textbox=u,function(t){var e=(a.prototype.onResizing=function(t,e,i,o){i=this.isSmallViewport(i),e=this.isSmallViewport(e);i!==e&&this.applyScaleOnElement(t,e,o)},a.prototype.onDataChanged=function(t,e,i){this.isSmallViewport(e)&&this.applyScaleOnElement(t,!0,i)},a.prototype.isSmallViewport=function(t){return!!t&&!!this.smallViewportProperties&&(t.height<=this.smallViewportProperties.minHeightToScaleFontSize||t.width<=this.smallViewportProperties.minWidthToScaleFontSize)},a.prototype.applyScaleOnElement=function(t,r,s){r&&(s=__assign(__assign({},s),{size:a.scale(s.size)})),t.find(u.ClassAndSelector.selector).css(F.FontProperties.toHTMLStyle(s)),t.find(l.TextRunElement.selector).each(function(t,e){var i,o;r?(o=void 0,o=(i=$(e).css("font-size"))?m.createFromCSS(i):s.size,o=a.scale(o)):(n=(n=$(e).data(l.ModelKeyName)).textStyle&&n.textStyle.fontSize)&&(o=m.createFromCSS(n));var n=s;o&&(n=__assign(__assign({},s),{size:o})),F.FontProperties.applyStyleToElement(n,e)})},a.scale=function(t){t=t.px,t=66<t?32:42<t?28:26<t?24:16<t?20:11<t?14:12;return m.createFromPx(t)},a);function a(t){this.smallViewportProperties=t}t.ViewModelAdapter=e;var i,e=(__extends(o,i=e),o);function o(){return i.call(this,{minHeightToScaleFontSize:1/0,minWidthToScaleFontSize:1/0})||this}t.AlwaysUseSmallViewport=e;n.format=function(t){return/^\S+@\S+\.\S+$/.test(t)?"mailto:"+t:/^https?:\/\//i.test(t)?t:"https://"+t},e=n;function n(){}t.LinkPreview=e}(x=F.TextboxHelpers||(F.TextboxHelpers={})),(v=l=F.RichTextConversion||(F.RichTextConversion={})).ModelKeyName="ModelObject",v.TextRunElement=jsCommon.CssConstants.createClassAndSelector("textRun"),v.convertDeltaToParagraphs=function(t,e,i){for(var o,n=[],r={textRuns:[]},s=!1,a=0,l=t.ops.length;a<l;a++){var u=t.ops[a],p=u.attributes,c=u.insert;if(void 0!==c)if(_.isString(c)){var h=c,s=!1;p&&p.align&&(void 0===r.horizontalTextAlignment||(r.horizontalTextAlignment,p.align),r.horizontalTextAlignment=p.align),p&&p.list&&(r.listType=p.list);var d,f=0,m=0,v=void 0;do{}while((m=h.indexOf(F.TextRunNewline,f))<0?(v=!1,m=h.length):v=!0,0<m-f&&(g={value:h.substring(f,m)},p&&(void 0!==p.link&&P(p.link)&&(g.url=p.link),(d=z(p))&&(g.textStyle=d)),r.textRuns.push(g)),v&&(0===r.textRuns.length&&r.textRuns.push({value:""}),n.push(r),r={textRuns:[]}),(f=m+1)<h.length)}else if(!_.isNumber(c)){var g,u=b(p,c);if(u)r.textRuns.push(u);else if(e)if(g=T(p,c)){if(F.TextEvaluation.isTextRunConditional(g)){c=F.TextEvaluation.evaluateTextRunConditional(g,i),c=F.TextEvaluation.combineEvaluatedTextRuns(c,i);if((c===F.TextRunNewline||c===F.TextRunNewlineHidden)&&!s){0===r.textRuns.length&&r.textRuns.push({value:""}),n.push(r),s=!(r={textRuns:[]});continue}s=!0}r.textRuns.push(g)}}}return 0<r.textRuns.length&&(o=_.first(r.textRuns),F.TextEvaluation.isTextRun(o)&&_.isString(o.value)&&0<o.value.length&&n.push(r)),n},v.convertParagraphsToHtml=function(t,a,l,u,p){for(var e=$(),i=0,o=t.length;i<o;++i){var c=t[i],h=!0,d=$("<p>").data(v.ModelKeyName,c);c.horizontalTextAlignment&&d.css("text-align",c.horizontalTextAlignment);for(var n=0,r=c.textRuns.length;n<r;++n)!function(t){var i,e=c.textRuns[t],o=void 0,n=void 0,r=void 0;if(F.TextEvaluation.isTextRun(e))o=e.value,n=e.textStyle,r=e.url,F.TextEvaluation.isAtMentionTextRun(e)&&(o="@"+o,(n=n||{}).color="#1453b3",i=e.mentionEmail);else{if(!F.TextEvaluation.isTextRunConditional(e))return;t=F.TextEvaluation.evaluateTextRunConditional(e,l);if((o=F.TextEvaluation.combineEvaluatedTextRuns(t,l))===F.TextRunNewlineHidden)return;_.isEmpty(t)||(n=t[0].textStyle,r=t[0].url)}_.isEmpty(o)||(h=!1);var s=void 0!==r&&P(r)?$("<a>").attr("href",r).attr("rel","noopener noreferrer").attr("target","_blank"):$("<span>"),o=F.TextEvaluation.getTextRunValue(o,l);s.text(o).addClass(v.TextRunElement.class).data(v.ModelKeyName,e);o=n;o&&(e={},o.fontFamily&&(e["font-family"]=A.getCssFontFamily(o.fontFamily,a)),o.fontSize&&(n=m.createFromCSS(o.fontSize),e["font-size"]=A.getCssFontSize(n,a)),o.fontStyle&&(e["font-style"]=o.fontStyle),o.fontWeight&&(e["font-weight"]=o.fontWeight),o.color&&(e.color=o.color),o.textDecoration&&(e["text-decoration"]=o.textDecoration),o.scriptType&&(e.lineHeight=o.lineHeight,e.position=o.position,e.verticalAlign=o.verticalAlign,o.scriptType===w.TextScriptTypes.Sub.toLowerCase()?e.bottom=o.bottom:e.top=o.top),s.css(e)),i&&s.on(f.pointerOverEventName,function(){p.showUser(i);var t=s.get(0),e=t.getBoundingClientRect();u.stop(!0,!0).css({left:t.offsetLeft,top:t.offsetTop-e.height-32}).delay(200).queue(function(t){s.is(":hover")&&u.fadeIn("fast"),t()})}).on(f.pointerOutEventName,function(){u.delay(500).queue(function(t){var e=function(t){u.is(":hover")?setTimeout(function(){return e(t)},500):t()};e(t)}).fadeOut("fast")}),d.append(s)}(n);c.listType===w.TextListTypes.Bullet&&(d.css("display","inline"),(d=d.wrap("<ul><li></li></ul>").parent().parent()).css("text-align",c.horizontalTextAlignment)),h&&d.append($("<br>")),e=e.add(d)}return e},v.convertParagraphsToOps=function(t,e,i,o,n,r){for(var s,a=[],l=0,u=0,p=t.length;u<p;++u){for(var c=t[u],h=0,d=c.textRuns.length;h<d;++h){var f=c.textRuns[h],m=void 0,v=void 0,g=void 0;if(F.TextEvaluation.isTextRun(f))m=f.textStyle,v=f.url,g=f.value;else{if(!F.TextEvaluation.isTextRunConditional(f))continue;_.isEmpty(f.cases)||(S=_.first(f.cases),_.isEmpty(S.textRuns)||(m=_.first(S.textRuns).textStyle,v=_.first(S.textRuns).url))}var y={},S=m;S&&(S.fontFamily&&(y.font=F.Font.normalizeFamily(w.getCSSFromFont((m=S.fontFamily,!_.startsWith(m,"'")||N.containsIgnoreCase(m,",")?m:(_.endsWith(m,"'"),m.slice(1,m.length-1)))))),S.fontSize&&(y.size=S.fontSize),S.color&&(y.color=S.color),y.italic="italic"===S.fontStyle||void 0,y.bold="bold"===S.fontWeight||void 0,y.underline="underline"===S.textDecoration||void 0,S.scriptType&&(y.script=S.scriptType));g=g;v&&P(v)&&(y.link=v);var C,x,v=void 0;v=E(g)?(C=g.selector.id,x={definition:f,destroyEditorActions:i.destroyEditorActions,evaluatedValues:e,localizationProvider:i.localizationProvider,objRef:C,onSelectSmartNarrativesBlot:function(t){var e;null!==(e=null==i?void 0:i.smartNarrativesEditorContainer)&&void 0!==e&&e.getSmartNarrativesEditor().onSelectEditableObject(t)},style:o},{attributes:y,insert:((s={})[A.QuillWrapper.smartNarrativesBlotClass.class]=x,s)}):F.TextEvaluation.isTextRunConditional(f)?(C=E(f.expression)?f.expression.selector.id:void 0,x={conditionalIndex:l,definition:f,destroyEditorActions:i.destroyEditorActions,evaluatedValues:e,localizationProvider:i.localizationProvider,objRef:C,onSelectSmartNarrativesBlot:function(t){var e;null!==(e=null==i?void 0:i.smartNarrativesEditorContainer)&&void 0!==e&&e.getSmartNarrativesEditor().onSelectEditableObject(t)},onSelectSmartNarrativesConditionalBlot:function(t){setTimeout(function(){null!=i&&i.setSelectionOfConditional(t)})},style:o},l++,{attributes:y,insert:((s={})[A.QuillWrapper.smartNarrativesConditionalBlotClass.class]=x,s)}):F.TextEvaluation.isAtMentionTextRun(f)?(x={email:f.mentionEmail,displayName:g,hoverContainer:n,personCardComponent:r},{attributes:y,insert:((f={})[A.QuillWrapper.atMentionBlotClass.class]=x,f)}):{attributes:y,insert:g},a.push(v)}var b={insert:"\n"};_.endsWith(_.last(a).insert,"\n");var T=function(t){var e={};t.horizontalTextAlignment&&(e.align=t.horizontalTextAlignment);t.listType&&(e.list=t.listType);return!_.isEmpty(e)&&e}(c);T&&(b.attributes=T),a.push(b)}return a},v.getAtMentionTextRun=b,v.getTextRunFromSmartNarrativesInsert=T,v.isValidLinkUrl=P,function(a){a.getCssFontFamily=function(t,e){return(t=w.getCSSFromFont(t))!==e.family?t:void 0},a.getCssFontSize=function(t,e){return null==t||t.equals(e.size)?"":t.pt+"pt"},a.QuillPlaceholder="__Placeholder__",a.getCustomQuillFormatValue=function(t,e){var i;return i=void 0!==t&&!_.isString(t.insert)&&!_.isNumber(t.insert)&&void 0!==t.insert?t.insert[e]:i};var s=(m.getFormatPath=function(t){return m.quillFormatsPath+"/"+t},m.prototype.updateOptions=function(t){var e,i=this;this.initialized?(this.options=t,(e=this.toolbar)&&e.updateOptions(t),this.smartNarrativesEditorContainer&&this.smartNarrativesEditorContainer.updateOptions(t)):this.dependenciesLoaded.then(function(){return i.updateOptions(t)})},m.prototype.initializeQuill=function(t){this.quillStatic=t,this.rebuildQuillEditor(),this.initialized=!0,this.quillReady.resolve(),this.quillStatic.debug("error")},m.prototype.getElement=function(){return this.$container},m.prototype.getContents=function(){if(this.initialized)return this.editor.getContents()},m.prototype.setContents=function(t){this.initialized,this.editor&&this.editor.setContents(t)},m.prototype.resize=function(t){this.$container.width(t.width),this.$container.height(t.height),this.updateToolbar()},m.prototype.setReadOnly=function(t){var e=t!==this.readOnly;this.readOnly=t,this.initialized&&e&&this.rebuildQuillEditor()},m.prototype.setSelection=function(t,e){this.editor&&this.editor.setSelection(t,e)},m.prototype.getSelection=function(t){if(this.editor)return this.editor.getSelection(t)},m.prototype.focus=function(){this.editor&&0===$(document.activeElement).closest(this.$container).length&&this.editor.focus()},m.prototype.destroy=function(){this.host.setToolbar(null),this.toolbar=null,this.$container.remove(),this.$container=null,this.destroyEditor()},m.prototype.destroyEditor=function(){this.editor&&(_.isEmpty(this.destroyEditorActions)||(_.forEach(this.destroyEditorActions,function(t){return t()}),this.destroyEditorActions=void 0),this.editor=null)},m.prototype.getSelectionAtCursor=function(){var t=this.getTextWithoutTrailingBreak(),e=this.getSelection(!0);if(e&&0===e.length){t=jsCommon.WordBreaker.find(e.index,t);return{index:t.start,length:t.end-t.start}}return e},m.prototype.getWord=function(){var t=this.getSelectionAtCursor();return this.getTextWithoutTrailingBreak().slice(t.index,t.index+t.length)},m.prototype.getEditorContainer=function(){if(this.editor)return $(this.editor.container)},m.prototype.setSelectionOfConditional=function(t){var e=this.getContents();if(e)for(var i=0,o=0,n=e.ops;o<n.length;o++){var r=n[o];if(!r)return;if(_.isString(r.insert))i+=r.insert.length;else if(_.isNumber(r.insert))i+=1;else{i+=1;r=a.getCustomQuillFormatValue(r,a.QuillWrapper.smartNarrativesConditionalBlotClass.class);if((null==r?void 0:r.conditionalIndex)===t){this.setSelection(i,0);break}}}},m.computeTransparentSmartNarrativesColor=function(t){t=o.parseColorString(t);return t.A=m.smartNarrativesPlaceholderOpacity,o.rgbString(t)},m.prototype.getTextWithoutTrailingBreak=function(){return this.editor.getText().slice(0,-1)},m.prototype.rebuildQuillEditor=function(){var t,o=this,e=null,i=this.options.supportsNarrativeExpressions;this.editor&&(e=this.editor.getContents()),this.$container.empty(),this.$container.keydown(function(t){var e=t.which;t.ctrlKey&&S.isCtrlShortcutKey(e)&&t.stopPropagation(),(S.isArrowKey(e)||S.isNudgeModifierKey(e))&&t.stopPropagation(),S.isDeleteKey(e)&&t.stopPropagation(),jsCommon.BrowserUtils.isCtrlOrMeta(t)&&117===t.keyCode&&(o.focusToolbar(),t.stopPropagation())});var n,r=$("<div>"),s={readOnly:this.readOnly,formats:["bold","italic","underline","font","size","link","align","color","script","list"],modules:{history:{userOnly:!0},keyboard:{bindings:{}}},placeholder:this.placeholderText},a=[];this.supportsAtMention&&(this.setupAtMentionFormat(),n=$("<div>"),a.push({mentionCharacter:"@",blotName:m.atMentionBlotClass.class,initialize:function(t,e){n.addClass(m.atMentionContainerClass.class).hide();o.userSuggestionsComponent=t.createUserSuggestions(n.get(0),function(t){e({displayName:t.displayName,email:t.email,hoverContainer:o.$mentionsHoverContainer,personCardComponent:o.personCardComponent})})},hideSuggestions:function(){return n.hide(),o.userSuggestionsComponent.hideSuggestions()},renderSuggestions:function(t,e,i){n.css({left:e,top:i}).show(),o.userSuggestionsComponent.showSuggestions(t)},pickSuggestion:function(){return o.userSuggestionsComponent.pickSuggestion()},navigateSuggestions:function(t){return o.userSuggestionsComponent.navigateSuggestions(t)}}),s.formats.push(m.atMentionBlotClass.class),s.modules.keyboard.bindings.enter={handler:d=function(){for(var t=!0,e=0,i=a;e<i.length;e++)t=i[e].pickSuggestion();return t},key:13},s.modules.keyboard.bindings.tab={handler:d,key:9}),_.isEmpty(a)||(s.modules.mention={save:function(){return o.saveState()},mentions:a,maxSearchLength:F.mentionDefaultMaxSearchLength,componentFactory:this.host.getUIComponentFactory()},this.registerMentionModule()),i&&(s.formats.push(m.smartNarrativesBlotClass.class),s.formats.push(m.smartNarrativesConditionalBlotClass.class),s.formats.push(m.smartNarrativesFocusFormatAttributeName));var l,u,p,c,h=v.buildToolbarLinkInputTemplate(this.localizationProvider),d=g.LinkInput.buildNode(h);this.readOnly||(h=this.toolbar,this.toolbar?h.updateOptions(this.options):((u=(h=this.toolbar=new g(this,this.localizationProvider,d,this.options)).getElement()).addClass("unselectable"),u.toggleClass("high-contrast",this.style.isHighContrast),s.modules.toolbar={container:u.get(0)}),r.attr("drag-resize-disabled","true")),this.destroyEditor(),this.destroyEditorActions=[],i&&(this.setUpSmartNarrativesFormat(),this.setUpSmartNarrativesConditionalFormat(),this.setUpSmartNarrativesFocusFormat()),this.editor=new this.quillStatic(r.get(0),s),this.readOnly||(l=new g.LinkInput(d,this.editor,this.quillStatic),u=this.toolbar.getElement(),p=new g.ColorPicker({quill:this.editor,hostServices:this.host,$colorSwatch:u.find(g.ColorPicker.colorSwatchGlyphClassAndSelector.selector),$colorPickerButton:u.find(g.ColorPicker.pickerButtonClassAndSelector.selector),$colorPickerButtonWrapper:u.find(g.ColorPicker.pickerButtonWrapperClassAndSelector.selector),defaultColor:F.ColorHelper.getThemeColor(this.style,F.ForegroundColorName),format:"color"}),m.setUpFontFormat(this.quillStatic),(c=this.editor.getModule("toolbar")).addHandler("link",function(t){t?(o.editor.setSelection(o.getSelectionAtCursor()),l.open()):l.remove()}),c.addHandler("color",function(){return p.applyFormat(p.getColor())}),this.destroyEditorActions.push(function(){c.addHandler("link",void 0),c.addHandler("color",void 0)}),i&&this.host.getUIComponentFactory()&&(this.smartNarrativesEditorContainer=new g.SmartNarrativesEditor({container:this.toolbar.getElement(),destroyEditorActions:this.destroyEditorActions,evaluatedValues:this.options.evaluatedValues,hostServices:this.host,localizationProvider:this.localizationProvider,onEditSmartNarrativePersist:this.textChanged,quill:this.editor,style:this.style,toolbar:this.toolbar}),this.smartNarrativesEditorContainer.getSmartNarrativesEditor()),this.supportsFormattingChangeIndication&&(this.formattingSettingsContainer=new g.FormattingSettings({container:this.toolbar.getElement(),hostServices:this.host}),this.formattingSettingsContainer.getTextboxFormattingSettings()),this.updateToolbar()),this.$container.append(r),this.$mentionsHoverContainer&&this.$container.append(this.$mentionsHoverContainer),n&&this.$container.append(n),e&&this.setContents(e),i||this.supportsFormattingChangeIndication?this.editor.keyboard.addBinding({key:83,shiftKey:!0,shortKey:!0},void 0,function(){o.saveState()}):this.throttleTextChanged(),this.supportsFormattingChangeIndication&&null!==(t=this.formattingSettingsContainer.getTextboxFormattingSettings())&&void 0!==t&&t.shouldListenToTextChanged()&&this.throttleTextChanged();function f(t){if(t=t.relatedTarget||document.activeElement){if(o.targetIsInToolbar(t,i))return;if((i||o.supportsFormattingChangeIndication)&&o.saveState(),m.willBrowserHandleFocus(t))return}o.setSelection(null,null)}this.editor.root.addEventListener("blur",f,!1),this.destroyEditorActions.push(function(){o.editor.root.removeEventListener("blur",f,!1)})},m.prototype.throttleTextChanged=function(){function t(t,e,i){if("api"!==i){for(var o=0,n=t.ops;o<n.length;o++){var r=n[o];if(m.isInsertOp(r)){r=r.insert;if(r&&N.containsWhitespace(r))return s.onTextChanged(),void a.cancel()}}a()}}var e,s=this,a=_.debounce(function(){return s.onTextChanged()},null!==(e=this.options.textChangeThrottle)&&void 0!==e?e:m.textChangeThrottle);this.editor.on("text-change",t),this.destroyEditorActions.push(function(){s.editor.off("text-change",t)}),this.onPaste&&this.$container.on("paste",function(){return setTimeout(function(){return s.onPaste()},0)})},m.setUpFontFormat=function(t){var i=t.import("parchment"),o=t.import(m.getFormatPath("font"));o.value=function(t){var e=m.camelize(o.keyName);return _.escape(F.Font.normalizeFamily(t.style[e]))},o.canAdd=function(t,e){return null!=i.query(t,i.Scope.BLOT&(o.scope|i.Scope.TYPE))&&(null==o.whitelist||-1<o.whitelist.indexOf(F.Font.normalizeFamily(_.unescape(e))))},o.add=function(t,e){if(!o.canAdd(t,e))return!1;var i=m.camelize(o.keyName),e=F.Font.normalizeFamily(_.unescape(e));return t.style[i]=e,!0}},m.prototype.isFormatRegisteredWithQuill=function(t){this.quillStatic;var e=this.quillStatic.imports;return!_.isEmpty(e)&&!!e[m.getFormatPath(t)]},m.prototype.setUpSmartNarrativesFormat=function(){var t,s;function e(){return null!==s&&s.apply(this,arguments)||this}this.isFormatRegisteredWithQuill(m.smartNarrativesBlotClass.class)||(t=this.quillStatic.import("blots/embed"),__extends(e,s=t),e.create=function(t){var e,i,o,n=s.create.call(this,t.objRef),r=F.ColorHelper.getDataColorByIndex(t.style,0);return t.objRef===a.QuillPlaceholder?(e=this.placeholderText,i=m.computeTransparentSmartNarrativesColor(r),$(n).addClass(m.smartNarrativesPlaceholderClass.class).css("background-color",i)):(e=F.TextEvaluation.getTextRunValueFormatted(t.objRef,t.evaluatedValues)||"",o=""+f.pointerDownEventName+m.smartNarrativesBlotClass.selector,t.destroyEditorActions&&($(n).on(o,function(){t.onSelectSmartNarrativesBlot(t.objRef)}),t.destroyEditorActions.push(function(){$(n).off(o)}))),$(n).attr(m.smartNarrativesBlotClass.class,t.objRef).attr(f.contentEditableAttribute,"false").css("border-bottom","1px solid "+r).data(m.smartNarrativesBlotClass.class,t),e?$(n).text(e):m.appendHiddenSmartNarrativesDisplay(n,t.localizationProvider.get("Visual_SmartNarratives_TextBox_Hidden")),n},e.value=function(t){return $(t).data(m.smartNarrativesBlotClass.class)},e.blotName=m.smartNarrativesBlotClass.class,e.className=m.smartNarrativesBlotClass.class,e.placeholderText="                ",e.tagName="span",this.quillStatic.register(e))},m.prototype.setUpSmartNarrativesConditionalFormat=function(){var t,o;function e(){return null!==o&&o.apply(this,arguments)||this}this.isFormatRegisteredWithQuill(m.smartNarrativesConditionalBlotClass.class)||(t=this.quillStatic.import("blots/embed"),__extends(e,o=t),e.create=function(n){if(F.TextEvaluation.isTextRunConditional(n.definition)){var r=o.create.call(this,n.objRef),s=""+f.pointerDownEventName+m.smartNarrativesConditionalBlotClass.selector;$(r).attr(m.smartNarrativesConditionalBlotClass.class,n.objRef).attr(f.contentEditableAttribute,"false").data(m.smartNarrativesConditionalBlotClass.class,n);for(var a=!1,t=F.TextEvaluation.evaluateTextRunConditional(n.definition,n.evaluatedValues),l=F.ColorHelper.getDataColorByIndex(n.style,0),e=0,i=t;e<i.length;e++)!function(t){var e=$("<span>");if(E(t.value)){var i=t.value.selector.id,o=F.TextEvaluation.getTextRunValueFormatted(i,n.evaluatedValues);if(!o)return;o=o;e.addClass(m.smartNarrativesBlotClass.class).css("border-bottom","1px solid "+l).text(o),n.destroyEditorActions&&(e.on(s,function(){n.onSelectSmartNarrativesBlot(i)}),n.destroyEditorActions.push(function(){e.off(s)}))}else t.value===F.TextRunNewlineHidden?(e.text(F.TextRunNewline),a=!0):e.text(t.value);$(r).append(e)}(i[e]);return 0===r.childElementCount?m.appendHiddenSmartNarrativesDisplay(r,n.localizationProvider.get("Visual_SmartNarratives_TextBox_Hidden")):r.innerText===F.TextRunNewline&&($(r).addClass(m.smartNarrativesNewlineClass.class).attr(f.contentEditableAttribute,"true").empty().text(F.TextRunNewline),a&&$(r).addClass(m.smartNarrativesHiddenClass.class)),n.destroyEditorActions&&($(r).on(s,function(){n.onSelectSmartNarrativesConditionalBlot(n.conditionalIndex)}),n.destroyEditorActions.push(function(){$(r).off(s)})),r}},e.value=function(t){return $(t).data(m.smartNarrativesConditionalBlotClass.class)},e.blotName=m.smartNarrativesConditionalBlotClass.class,e.className=m.smartNarrativesConditionalBlotClass.class,e.tagName="span",this.quillStatic.register(e))},m.prototype.setUpSmartNarrativesFocusFormat=function(){var t,e,i=m.getFormatPath(m.smartNarrativesFocusFormatAttributeName);this.isFormatRegisteredWithQuill(i)||((e=this.quillStatic.import(m.getFormatPath("background"))).attrName=m.smartNarrativesFocusFormatAttributeName,this.quillStatic.register(((t={})[i]=e,t)))},m.prototype.setupAtMentionFormat=function(){var t,o;function n(){return null!==o&&o.apply(this,arguments)||this}this.isFormatRegisteredWithQuill(m.atMentionBlotClass.class)||(t=this.quillStatic.import("blots/embed"),__extends(n,o=t),n.create=function(i){var t,e=o.create.call(this,i.email);return $(e).attr(m.atMentionBlotClass.class,i.email).attr(f.contentEditableAttribute,"false").data(m.atMentionBlotClass.class,i).on(f.pointerOverEventName,function(){i.personCardComponent.showUser(i.email);var t=e.getBoundingClientRect();i.hoverContainer.stop(!0,!0).css({left:e.offsetLeft,top:e.offsetTop-t.height-n.topPaddingOffset}).delay(200).queue(function(t){$(e).is(":hover")&&i.hoverContainer.fadeIn("fast"),t()})}).on(f.pointerOutEventName,function(){i.hoverContainer.delay(500).queue(function(t){function e(t){i.hoverContainer.is(":hover")?setTimeout(function(){return e(t)},500):t()}e(t)}).fadeOut("fast")}).css("color","#1453b3").text(null!==(t="@"+i.displayName)?t:i.email),e},n.value=function(t){return $(t).data(m.atMentionBlotClass.class)},n.blotName=m.atMentionBlotClass.class,n.className=m.atMentionBlotClass.class,n.tagName="span",n.topPaddingOffset=24,this.quillStatic.register(n))},m.prototype.registerMentionModule=function(){function u(t,i){var o=this;this.options=i,this.quill=t,_.isEmpty(i.mentions),t.on("text-change",function(t,e,i){return o.onTextChange(t,e,i)});for(var e=0,n=i.mentions;e<n.length;e++)!function(e){e.mentionCharacter.length,e.initialize(i.componentFactory,function(t){return o.insertBlot(e.blotName,t)})}(n[e]);this.addKeyBindings()}this.quillStatic.imports["modules/mention"]||(u.prototype.addKeyBindings=function(){function t(t){for(var e=!0,i=0,o=n.options.mentions;i<o.length;i++)e=o[i].navigateSuggestions(t);return e}var n=this;this.quill.keyboard.addBinding({key:40},void 0,function(){return t(0)}),this.quill.keyboard.addBinding({key:38},void 0,function(){return t(1)});this.quill.keyboard.addBinding({key:27},void 0,function(){for(var t=!0,e=0,i=n.options.mentions;e<i.length;e++)t=i[e].hideSuggestions();return t})},u.prototype.onTextChange=function(t,e,i){if("user"===i){this.insertPosition=void 0,this.currentPosition=void 0;var o=this.quill.getSelection();if(o){this.currentPosition=o.index;var n=Math.max(0,this.currentPosition-this.options.maxSearchLength),i=this.quill.getText(n,this.currentPosition-n),o=this.getMentionConfig(i),r=o.mentionConfig,n=o.mentionCharacterPosition;if(r){for(var o=i.substring(n+1),s=0,a=this.options.mentions;s<a.length;s++){var l=a[s];l!==r&&l.hideSuggestions()}this.insertPosition=this.currentPosition-o.length-1;i=this.quill.getBounds(this.insertPosition),n=this.quill.root.getBoundingClientRect(),n=Math.min(i.left,n.width-u.SuggestionWidth),i=i.height+i.bottom;r.renderSuggestions(o,n,i)}else this.hideAllSuggestions()}}},u.prototype.getMentionConfig=function(t){for(var e=0,i=this.options.mentions;e<i.length;e++){var o=i[e],n=t.lastIndexOf(o.mentionCharacter);if(-1!==n)return{mentionConfig:o,mentionCharacterPosition:n}}return{mentionConfig:void 0,mentionCharacterPosition:-1}},u.prototype.insertBlot=function(t,e){this.hideAllSuggestions(),_.isNil(this.insertPosition)||_.isNil(this.currentPosition)||(this.quill.deleteText(this.insertPosition,this.currentPosition-this.insertPosition,"api"),this.quill.insertEmbed(this.insertPosition,t,e,"api"),this.quill.setSelection(this.insertPosition+1,0,"api"),this.options.save())},u.prototype.hideAllSuggestions=function(){for(var t=0,e=this.options.mentions;t<e.length;t++)e[t].hideSuggestions()},u.SuggestionWidth=200,this.quillStatic.register("modules/mention",u))},m.willBrowserHandleFocus=function(t){return"SELECT"===t.tagName||"INPUT"===t.tagName||!!t.getAttribute("contentEditable")},m.prototype.targetIsInToolbar=function(t,e){if(!this.toolbar)return!1;if("A"===t.tagName||"BUTTON"===t.tagName||e){e=$(t),t=this.toolbar.getElement();return t.is(":visible")&&(e.is(t)||0<e.closest(t).length)}return!1},m.prototype.onTextChanged=function(){var t;this.textChanged(),this.supportsFormattingChangeIndication&&null!==(t=this.formattingSettingsContainer.getTextboxFormattingSettings())&&void 0!==t&&t.onTextChanged()},m.prototype.saveState=function(){var t;null!==(t=null===(t=this.editor)||void 0===t?void 0:t.history)&&void 0!==t&&t.clear(),this.onTextChanged()},m.isInsertOp=function(t){return null!=t.insert},m.camelize=function(t){var e=t.split("-"),t=_.map(e.slice(1),function(t){return t[0].toUpperCase()+t.slice(1)}).join("");return e[0]+t},m.prototype.focusToolbar=function(){if(!this.editor||!this.toolbar)return!1;y.focusChildInGroup(this.toolbar.getElement().get(0))},m.appendHiddenSmartNarrativesDisplay=function(t,e){var i=$("<span>"),o=$("<span>"),n=$("<span>");i.text("["),o.addClass("glyphicon glyph-mini pbi-glyph-hide3"),n.text("]"),$(t).addClass(m.smartNarrativesHiddenClass.class).append(i,o,n).attr("title",e)},m.prototype.updateToolbar=function(){var t;this.toolbar&&(t=null===(t=this.options)||void 0===t?void 0:t.supportsNarrativeExpressions,this.host.setToolbar(this.toolbar.getElement(),{preferHorizontalLayout:t,theme:t?"neutralGrayTheme":"darkTheme"}))},m.quillFormatsPath="formats",m.atMentionBlotClass=d("at-mention"),m.atMentionContainerClass=d("mentions-container"),m.smartNarrativesBlotClass=d("smart-narratives-blot"),m.smartNarrativesConditionalBlotClass=d("smart-narratives-conditional-blot"),m.smartNarrativesFocusFormatAttributeName="smartNarrativesFocus",m.smartNarrativesHiddenClass=d("smart-narratives-hidden"),m.smartNarrativesNewlineClass=d("smart-narratives-newline"),m.smartNarrativesPlaceholderClass=d("placeholder"),m.smartNarrativesPlaceholderOpacity=.2,m.textChangeThrottle=600,m);function m(t,e,i,o,n,r,s,a,l){var u=this;this.readOnly=t,this.host=e,this.style=i,this.options=o,this.supportsAtMention=n,this.$mentionsHoverContainer=r,this.personCardComponent=s,this.placeholderText=a,this.supportsFormattingChangeIndication=l,this.textChanged=_.noop,this.$container=$("<div>"),this.localizationProvider={get:function(t){return u.host.getLocalizedString(t)},getOptional:function(t){return u.host.getLocalizedString(t)},format:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return u.host.getLocalizedString(t,e)}},this.quillReady=this.host.promiseFactory().defer(),F.TextboxUtil.getLoadQuillResources()?(this.initialized=!1,this.dependenciesLoaded=this.host.loader().require({javascript:"quill",css:["quill.core"]}).then(function(t){return u.initializeQuill(t)})):(this.initializeQuill(window.Quill),this.dependenciesLoaded=this.host.promiseFactory().resolve())}a.QuillWrapper=s;var v,t,g=(l.prototype.getElement=function(){return this.container},l.prototype.updateOptions=function(t){var e=t.defaultFont;this.onEscape=t.onEscape,this.updateFontFamilyUI(e,t.fontFamilies),this.updateFontSizeUI(e,t.fontSizes),this.updateTextAlignmentUI(),this.featureSwitches&&this.featureSwitches.textboxSuperSubScriptBulletedList&&this.updateTextScriptUI()},l.prototype.updateFontSizeUI=function(t,e){var i=s.getFormatPath("size");this.updateStyleAllowList(this.quillWrapper.quillStatic,"size",null,i,!0),this.fontSizes=_.map(e,function(t){return{label:""+t,value:t+"pt"}}),this.defaultFontSize=t.size.pt+"pt",this.fontSizePicker?v.updatePicker(this.fontSizePicker,this.fontSizes,this.defaultFontSize):this.fontSizePicker=v.picker(v.getTooltip("Size",this.localizationProvider),this.fontSizes,"size",this.defaultFontSize)},l.prototype.updateFontFamilyUI=function(t,e){var i=e.map(function(t){return F.Font.normalizeFamily(w.getCSSFromFont(t))}),o=s.getFormatPath("font");this.updateStyleAllowList(this.quillWrapper.quillStatic,"font",i,o,!0),this.fontFamilies=_.map(e,function(t){return{label:t,value:_.escape(F.Font.normalizeFamily(w.getCSSFromFont(t)))}}),this.defaultFontFamily=_.escape(F.Font.normalizeFamily(w.getCSSFromFont(t.family))),this.fontFamilyPicker?v.updatePicker(this.fontFamilyPicker,this.fontFamilies,this.defaultFontFamily):this.fontFamilyPicker=v.picker(v.getTooltip("Font",this.localizationProvider),this.fontFamilies,"font",this.defaultFontFamily,function(t,e){return t.css("font-family",e.value),t})},l.prototype.updateTextAlignmentUI=function(){var i=this.defaultTextAlignment=w.DefaultAlignment;this.textAlignments=_.map(w.TextAlignments,function(t){var e=t.toLowerCase();return{label:t,value:t===i?"":e,glyph:"align"+e}});var t=_.map(this.textAlignments,function(t){return t.value}),e=s.getFormatPath("align");this.updateAllowList(this.quillWrapper.quillStatic,e,t),this.textAlignmentGroup||(this.textAlignmentGroup=v.toggleGroup("Text Alignment",this.textAlignments,"align",this.defaultTextAlignment,this.localizationProvider,!1))},l.prototype.updateTextScriptUI=function(){this.textScripts=_.map(w.TextScriptTypes,function(t){var e=t.toLowerCase();return{label:t,value:e,glyph:e+"script"}});var t=_.map(this.textScripts,function(t){return t.value}),e=s.getFormatPath("script");this.updateAllowList(this.quillWrapper.quillStatic,e,t),this.textScriptGroup||(this.textScriptGroup=v.toggleGroup("Script",this.textScripts,"script","",this.localizationProvider,!0))},l.prototype.updateStyleAllowList=function(t,e,i,o,n){this.updateAllowList(t,"attributors/style/"+e,i,o,n=void 0===n?!1:n)},l.prototype.updateAllowList=function(t,e,i,o,n){void 0===n&&(n=!1);var r=t.import(e);r.whitelist=i,t.register(o||e,r,n)},l);function l(t,e,i,o){this.quillWrapper=t,this.localizationProvider=e,this.linkInput=i,this.featureSwitches=o.featureSwitches,this.updateOptions(o);var n=l.ColorPicker.buildFontColorButtons(e.get("Visual_FontColor"),e.get("Visual_FontColor_Picker")),t=this.container=v.div().addClass("toolbar").addClass("themeableElement").attr("aria-label",v.getTooltip("FontControl",e)).attr("focus-nav-mode","Group"),i=v.formatGroup();1<_.size(this.fontFamilies)&&i.append(this.fontFamilyPicker),1<_.size(this.fontSizes)&&i.append(this.fontSizePicker),i.append(n);i=v.div().addClass("toolbar-content").append(i).append(v.formatGroup().append(v.formatButton(v.getTooltip("Bold",e),"bold")).append(v.formatButton(v.getTooltip("Italic",e),"italic",null,"italic",!0)).append(v.formatButton(v.getTooltip("Underline",e),"underline"))).append(v.formatGroup().append(this.textAlignmentGroup)).append(v.formatGroup().append(v.formatButton(v.getTooltip("Link",e),"link")).append(this.linkInput));this.featureSwitches&&this.featureSwitches.textboxSuperSubScriptBulletedList&&i.append(v.formatGroup().append(this.textScriptGroup)).append(v.formatGroup().append(v.formatButton(v.getTooltip("BulletedList",e),"list","bullet","bulletedlist",!0))),t.append(i),o.supportsNarrativeExpressions&&(i.addClass("fixed-size"),t.append(v.smartNarrativesEditor())),o.supportsFormattingChangeIndication&&!this.quillWrapper.readOnly&&t.append(v.formattingSettingsGroup()),this.featureSwitches&&this.featureSwitches.textboxSuperSubScriptBulletedList&&i.css("width","645px");var r=this.onEscape;r&&t.on("keydown",function(t){27===t.keyCode&&(t.stopPropagation(),t.preventDefault(),r())})}function r(){return $("<div>")}function e(){return $("<span>")}function u(){return $("<button>")}function p(t,e,i,o){return $("<select>").attr("title",t).attr("aria-label",t).append(n(e,i,o))}function i(t,e,i,o){return t.empty().append(n(e,i,o))}function n(t,i,o){return _.map(t,function(t){var e=$("<option>").text(t.label);return t.value===i?e.attr("selected","selected"):e.attr("value",t.value),e=void 0!==o?o(e,t):e})}function c(t,e,i,o,n){var r=u();return null!=t&&r.attr("title",t).attr("aria-label",t),null!=e&&r.addClass("ql-"+e),null!=i&&r.attr("value",i),null==o&&(null!=e&&(o=e),null!=i&&(o=(o||"")+i)),null!=o&&n?(r.addClass("pbi-glyph-"+o),r.addClass(e),r.css("font-family","PowrMDL2")):r.addClass("powervisuals-glyph "+o),r}function h(t,e){return e.get("RichTextbox_"+t+"_ToolTip")}a.Toolbar=g,(t=v=a.ToolbarBuilder||(a.ToolbarBuilder={})).buildToolbarLinkInputTemplate=function(t){var e=r(),i=t.get("RichTextbox_Link_Done"),o=t.get("RichTextbox_Link_Remove"),n=t.get("RichTextbox_Link_Edit"),t=h("Link",t);return e.append($('\n                        <a href="#" class="ql-preview" target="_blank"></a>\n                        <input class="input" type="text" aria-label="'+t+'">\n                        <span class="bar">&nbsp;|&nbsp;</span>\n                        <button class="ql-action ql-save">'+i+'</button>\n                        <button class="ql-action ql-edit">'+n+'</button>\n                        <button class="ql-remove">'+o+"</button>\n                    ")),e.html()},t.formatGroup=function(){return e().addClass("ql-formats")},t.smartNarrativesEditor=function(){return r().addClass(t.smartNarrativesEditorClass.class)},t.formattingSettingsGroup=function(){return r().addClass(t.formattingSettingsClass.class)},t.div=r,t.span=e,t.button=u,t.toggleGroup=function(t,e,i,o,n,r){return e.map(function(t){var e=null!=t.glyph?t.glyph:i+t.value;return c(h(t.label,n),i,t.value,e,r)})},t.picker=function(t,e,i,o,n){return p(t,e,o,n).addClass("ql-"+i+" ql-picker")},t.updatePicker=i,t.selector=p,t.updateSelector=i,t.options=n,t.formatButton=c,t.getTooltip=h,t.smartNarrativesEditorClass=d("smart-narratives-editor"),t.formattingSettingsClass=d("formatting-settings"),function(t){var e=(i.buildNode=function(t){return v.div().addClass(C.toolbarUrlInput.class).append($(t))},i.prototype.onHide=function(t){this.hide(),this.stopEvent(t)},i.prototype.onSave=function(t){this.save(),this.stopEvent(t)},i.prototype.onEdit=function(t){this.edit(),this.stopEvent(t)},i.prototype.onRemove=function(t){this.remove(),this.stopEvent(t)},i.prototype.stopEvent=function(t){t.stopPropagation(),t.preventDefault()},i.prototype.edit=function(){this.isEditing=!0,this.$container.addClass(i.editingClass),this.$textbox.focus(),this.textbox.setSelectionRange(0,this.textbox.value.length)},i.prototype.open=function(){this.range=this.quill.getSelection(),this.show(),this.edit()},i.prototype.hide=function(){this.range=this.link=null,this.$container.hide(),this.isEditing=!1},i.prototype.remove=function(){this.range=this.range||this.quill.getSelection(),this.quill.formatText(this.range,"link",!1,"user"),this.quill.setSelection(this.range,"silent"),this.hide()},i.prototype.save=function(){var t=this.range,e=this.textbox.value;0===t.length&&(this.quill.insertText(this.range.index,e),this.quill.setSelection(this.range.index,e.length),t=this.range=this.quill.getSelection()),this.quill.formatText(t.index,t.length,"link",e,"user"),this.quill.setSelection(t,"silent"),this.link=this.quill.scroll.descendant(this.quillStatic.import(s.getFormatPath("link")),t.index)[0],this.show()},i.prototype.show=function(){this.isEditing=!1,this.$container.removeClass(i.editingClass),this.$container.show();var t=this.range=this.range||this.quill.getSelection(),e=null!=this.link?this.link.formats().link:(e=this.quill.getText(t.index,t.length),x.LinkPreview.format(e));this.$textbox.val(e),this.$preview.text(e),this.$preview.attr("href",e)},i.editingClass="ql-editing",i);function i(t,o,e){var n=this;this.$container=t,this.quill=o,this.quillStatic=e,this.$preview=this.$container.find("a.ql-preview"),this.$textbox=this.$container.find("input[type=text]"),this.textbox=this.$textbox[0],this.$action=this.$container.find(".ql-action"),this.hide(),this.$textbox.on("keydown",function(t){13===t.keyCode?n.onSave(t):27===t.keyCode&&n.onHide(t)}),["click","touchstart"].forEach(function(t){n.$action.on(t,function(t){n.$container.hasClass(i.editingClass)?n.onSave(t):n.onEdit(t)}),n.$container.find(".ql-remove").on(t,function(t){return n.onRemove(t)})}),o.on("selection-change",function(t){if(null!=t||!n.isEditing){if(null!=t&&0===t.length){var e=o.scroll.descendant(n.quillStatic.import(s.getFormatPath("link")),t.index);if(n.link=e[0],i=e[1],null!=n.link){var i={index:t.index-i,length:n.link.length()};return void(_.isEqual(n.range,i)||(n.range=i,n.show()))}0<t.index&&o.scroll.descendant(n.quillStatic.import(s.getFormatPath("link")),t.index-1)[0]&&setTimeout(function(){return n.quill.format("link",!1)})}n.hide()}})}t.LinkInput=e;n.buildFontColorButtons=function(t,e){var i=$("<span></span>").addClass("powervisuals-glyph").addClass(n.colorGlyphClassAndSelector.class),o=$("<span></span>").addClass("powervisuals-glyph").addClass(n.colorSwatchGlyphClassAndSelector.class),o=$("<button>").addClass("ql-color").addClass(n.colorButtonClassAndSelector.class).attr("title",t).attr("aria-label",t).val("false").append(i).append(o),e=$("<button>").addClass("colorpicker powervisuals-glyph chevrondown").addClass(n.pickerButtonClassAndSelector.class).attr("title",e).attr("aria-label",e).val("false");return[o,$("<div>").addClass(n.pickerButtonWrapperClassAndSelector.class).append(e)]},n.prototype.onColorChange=function(t){this.currentColor.toUpperCase()!==t.toUpperCase()&&(this.setSwatch(t||this.defaultColor),this.applyFormat(t||null,this.range),this.currentColor=t)},n.prototype.onClose=function(){var t=this.ensureRange();this.quill.setSelection(t.index,t.length),this.color?this.quill.format(this.format,this.color,"user"):this.quill.format(this.format,!1,"user")},n.prototype.getColor=function(){return this.currentColor},n.prototype.applyFormat=function(t,e){e=this.ensureRange(e);(this.color=t)&&t!==this.defaultColor?(this.quill.formatText(e.index,e.length,this.format,t,"user"),this.quill.format(this.format,this.color,"user")):(this.quill.formatText(e.index,e.length,this.format,!1,"user"),this.quill.format(this.format,!1,"user"))},n.prototype.toggle=function(){this.range=this.ensureRange(),this.getColorPicker().toggle()},n.prototype.getColorPicker=function(){var e=this,t=this.$colorPickerButtonWrapper.get(0);return this.colorPicker=this.hostServices.getUIComponentFactory().createColorPicker(t.firstChild,{value:this.getRangeColor()},function(t){return e.onColorChange(t&&t.value)},function(){return e.onClose()}),this.colorPicker},n.prototype.getRangeColor=function(){var t=this.quill.getSelection();if(!t)return this.defaultColor;t=this.quill.getFormat(t.index,t.length);return"string"==typeof(null==t?void 0:t.color)?t.color:this.defaultColor},n.prototype.setSwatch=function(t){this.$colorSwatch.get(0).style.setProperty("color",t,"important")},n.prototype.ensureRange=function(t){return this.quill.focus(),t||this.quill.getSelection()||{index:0,length:0}},n.colorGlyphClassAndSelector=d("fontcolor"),n.colorSwatchGlyphClassAndSelector=d("fontcolorswatch"),n.colorButtonClassAndSelector=d("fontcolorbutton"),n.pickerButtonClassAndSelector=d("fontcolorpicker"),n.pickerButtonWrapperClassAndSelector=d("fontcolorbutton-wrapper"),e=n;function n(t){var e=this;this.quill=t.quill,this.hostServices=t.hostServices,this.$colorSwatch=t.$colorSwatch,this.$colorPickerButtonWrapper=t.$colorPickerButtonWrapper,this.defaultColor=t.defaultColor,this.format=t.format,this.currentColor=t.defaultColor,this.setSwatch(this.currentColor),t.$colorPickerButton.on("click",function(t){t.stopPropagation(),e.toggle()})}t.ColorPicker=e;o.prototype.getSmartNarrativesEditor=function(){var i=this;return this.component=this.component||this.hostServices.getUIComponentFactory().createSmartNarrativesEditor(this.container.find(v.smartNarrativesEditorClass.selector).get(0),F.textboxProps.values.expr,{onEditSmartNarrativeCancel:function(){return i.onEditSmartNarrativeCancel()},onEditSmartNarrativeFinish:function(t,e){return i.onEditSmartNarrativeFinish(t,e)},onEditSmartNarrativeStart:function(){return i.onEditSmartNarrativeStart()},onSmartNarrativeFocusChange:function(t,e){return i.onSmartNarrativeFocusChange(t,e)},onUpdateToolbar:function(){return i.onUpdateToolbar()},onEscape:function(){return i.focusOnToolbar()}}),this.component},o.prototype.onGetSmartNarrativesBlot=function(e){var i={index:-1,op:void 0},t=this.quill.getContents();return t&&(i.op=_.find(t.ops,function(t){if(t){if(_.isString(t.insert))return i.index+=t.insert.length,!1;if(_.isNumber(t.insert))return i.index+=1,!1;t=a.getCustomQuillFormatValue(t,a.QuillWrapper.smartNarrativesBlotClass.class);return i.index+=1,(null==t?void 0:t.objRef)===e}return!1})),i},o.prototype.onEditSmartNarrativeCancel=function(){var t=-1,e=this.onGetSmartNarrativesBlot(a.QuillPlaceholder);return e&&0<=e.index&&e.op&&(this.quill.removeFormat(e.index,1),t=e.index,this.quill.setSelection(t,0,"api")),t},o.prototype.onEditSmartNarrativeFinish=function(e,t){var i=this,o=this.onEditSmartNarrativeCancel();t?this.applyObjRefUpdate(t,function(t){i.quill.removeFormat(t,1),i.insertSmartNarrativesBlot(e,t)}):(o<0&&(o=this.getInsertionIndex()),this.insertSmartNarrativesBlot(e,o)),this.onEditSmartNarrativePersist()},o.prototype.onEditSmartNarrativeStart=function(){this.onEditSmartNarrativeCancel();var t=this.getInsertionIndex();this.insertSmartNarrativesBlot(a.QuillPlaceholder,t)},o.prototype.onSmartNarrativeFocusChange=function(t,i){var o=this;this.applyObjRefUpdate(t,function(t){var e=o.quill.getFormat(t,1);e.smartNarrativesFocus=i?o.focusColor:void 0,o.quill.formatText(t,1,e,"api")})},o.prototype.updateOptions=function(t){this.evaluatedValues=t.evaluatedValues},o.prototype.applyObjRefUpdate=function(t,e){var i=this.quill.getContents();if(i)for(var o=-1,n=0,r=i.ops;n<r.length;n++){var s=r[n];if(!s)return;_.isString(s.insert)?o+=s.insert.length:_.isNumber(s.insert)?o+=1:(o+=1,(null==(s=a.getCustomQuillFormatValue(s,a.QuillWrapper.smartNarrativesBlotClass.class))?void 0:s.objRef)===t&&e(o))}},o.prototype.getInsertionIndex=function(){var t=this.quill.getSelection(!0);return t?t.index:0},o.prototype.insertSmartNarrativesBlot=function(t,e){var i=this,t={destroyEditorActions:this.destroyEditorActions,evaluatedValues:this.evaluatedValues,localizationProvider:this.localizationProvider,objRef:t,onSelectSmartNarrativesBlot:function(t){i.getSmartNarrativesEditor().onSelectEditableObject(t)},style:this.style};this.quill.insertEmbed(e,s.smartNarrativesBlotClass.class,t,"api"),this.quill.setSelection(e+1,0,"api")},o.prototype.onUpdateToolbar=function(){this.hostServices.setToolbar(this.toolbar.getElement(),{preferHorizontalLayout:!0,theme:"neutralGrayTheme"})},o.prototype.focusOnToolbar=function(){this.toolbar&&y.focusChildInGroup(this.toolbar.getElement().get(0))},e=o;function o(t){this.container=t.container,this.destroyEditorActions=t.destroyEditorActions,this.evaluatedValues=t.evaluatedValues,this.hostServices=t.hostServices,this.localizationProvider=t.localizationProvider,this.onEditSmartNarrativePersist=t.onEditSmartNarrativePersist,this.quill=t.quill,this.style=t.style,this.toolbar=t.toolbar,this.container,this.destroyEditorActions,this.evaluatedValues,this.hostServices,this.localizationProvider,this.onEditSmartNarrativePersist,this.quill,this.style,this.toolbar;t=F.ColorHelper.getDataColorByIndex(t.style,0);this.focusColor=a.QuillWrapper.computeTransparentSmartNarrativesColor(t)}t.SmartNarrativesEditor=e;r.prototype.getTextboxFormattingSettings=function(){var t;return this.component=this.component||(null===(t=this.hostServices.getUIComponentFactory())||void 0===t?void 0:t.createTextboxFormattingSettings(this.container.find(v.formattingSettingsClass.selector).get(0))),this.component},e=r;function r(t){this.container=t.container,this.hostServices=t.hostServices,this.container,this.hostServices}t.FormattingSettings=e}(g=a.Toolbar||(a.Toolbar={}))}(A=F.RichText||(F.RichText={}))}(c.visuals||(c.visuals={}))}(powerbi=powerbi||{}),define("TextboxVisual/textboxModule",["require","exports"],function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.createAlwaysUseSmallViewportTextboxViewModelAdapter=e.createTextboxViewModelAdapter=e.createTextbox=void 0,e.createTextbox=function(t){return new powerbi.visuals.Textbox(t)},e.createTextboxViewModelAdapter=function(t){return new powerbi.visuals.TextboxHelpers.ViewModelAdapter(t)},e.createAlwaysUseSmallViewportTextboxViewModelAdapter=function(){return new powerbi.visuals.TextboxHelpers.AlwaysUseSmallViewport}}),function(t){((t=t.powerbi||(t.powerbi={})).visuals||(t.visuals={})).importTextboxModule=function(){}}(es6=es6||{}),function(t){var e;(e=t.visuals||(t.visuals={})).initializeTextboxVisualFactoryES6=function(){e.setCreateTextbox(function(e){return es6.powerbi.visuals.importTextboxModule().then(function(t){return t.createTextbox(e)})}),e.setCreateTextboxViewModelAdapter(function(e){return es6.powerbi.visuals.importTextboxModule().then(function(t){return t.createTextboxViewModelAdapter(e)})}),e.setCreateAlwaysUseSmallViewportTextboxViewModelAdapter(function(){return es6.powerbi.visuals.importTextboxModule().then(function(t){return t.createAlwaysUseSmallViewportTextboxViewModelAdapter()})})}}(powerbi=powerbi||{});
this.parseTimeMarkers = this.parseTimeMarkers || {};
var marker = this.parseTimeMarkers['textboxVisual.min.js'] || (this.parseTimeMarkers['textboxVisual.min.js'] = {});
marker.endEval = window.jsCommon && window.jsCommon.performance && window.jsCommon.performance.now ? window.jsCommon.performance.now() : Date.now(); marker.isExternal = false;
